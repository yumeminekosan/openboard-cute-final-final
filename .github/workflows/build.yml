name: Build
on: [push, pull_request]
env:
  CI_NAME: GitHub Actions

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - uses: android-actions/setup-android@v3

      - name: Download and extract native libraries
        run: |
          mkdir -p app/prebuilt
          
          # 使用最新nightly build
          echo "Downloading Trime native libraries..."
          
          # 获取最新的nightly artifact
          # 使用v3.3.8作为备选
          for abi in arm64-v8a armeabi-v7a x86 x86_64; do
            echo "Downloading $abi..."
            curl -L -o "trime-${abi}.apk" "https://github.com/osfans/trime/releases/download/v3.3.8/com.osfans.trime-v3.3.8-0-gf3f5c923-${abi}-release.apk" || true
            
            if [ -f "trime-${abi}.apk" ]; then
              mkdir -p "app/prebuilt/${abi}"
              # APK中native库在lib/<abi>/目录
              unzip -j "trime-${abi}.apk" "lib/${abi}/*" -d "app/prebuilt/${abi}/" 2>/dev/null || \
              unzip -j "trime-${abi}.apk" -d "app/prebuilt/${abi}/" 2>/dev/null || true
              echo "Extracted $abi:"
              ls -la "app/prebuilt/${abi}/" || true
            fi
          done
          
          # 检查是否有.so文件
          echo "Checking prebuilt libraries..."
          find app/prebuilt -name "*.so" || echo "No .so files found!"
          
          # 如果没有找到，尝试另一种方式
          if [ ! -f "app/prebuilt/arm64-v8a/librime.so" ]; then
            echo "Trying alternative extraction..."
            # 下载universal APK
            curl -L -o trime-universal.apk "https://github.com/osfans/trime/releases/download/v3.3.8/com.osfans.trime-v3.3.8-0-gf3f5c923-universal-release.apk" || true
            if [ -f "trime-universal.apk" ]; then
              unzip trime-universal.apk -d trime-extracted/ || true
              for abi in arm64-v8a armeabi-v7a x86 x86_64; do
                if [ -d "trime-extracted/lib/${abi}" ]; then
                  mkdir -p "app/prebuilt/${abi}"
                  cp -r trime-extracted/lib/${abi}/* "app/prebuilt/${abi}/" || true
                fi
              done
            fi
          fi
          
          echo "Final prebuilt structure:"
          find app/prebuilt -name "*.so" -type f || echo "ERROR: No .so files found!"

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git describe --tags --long --always || echo "No tags"

      - name: Build Debug APK
        run: |
          chmod +x gradlew
          ./gradlew :app:assembleDebug --no-daemon --stacktrace

      - name: List output
        if: always()
        run: |
          find app/build/outputs -name "*.apk" || true

      - uses: actions/upload-artifact@v4
        with:
          name: kitten-keyboard-apk
          path: app/build/outputs/apk/debug/*.apk
