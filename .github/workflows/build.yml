name: Build
on: [push, pull_request]
env:
  CI_NAME: GitHub Actions

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - uses: android-actions/setup-android@v3

      - name: Download and extract native libraries
        run: |
          mkdir -p app/prebuilt
          
          echo "Downloading Trime native libraries from official release v3.3.8..."
          
          # 从Trime官方release下载各架构APK并提取native库
          # native库文件名是 librime_jni.so（不是 librime.so）
          for abi in arm64-v8a armeabi-v7a x86 x86_64; do
            echo "=== Downloading $abi ==="
            curl -L -o "trime-${abi}.apk" "https://github.com/osfans/trime/releases/download/v3.3.8/com.osfans.trime-v3.3.8-0-gf3f5c923-${abi}-release.apk" || true
            
            if [ -f "trime-${abi}.apk" ]; then
              mkdir -p "app/prebuilt/${abi}"
              # APK中native库在lib/<abi>/目录下
              # 使用unzip -j去掉路径前缀，直接提取到目标目录
              unzip -j "trime-${abi}.apk" "lib/${abi}/*" -d "app/prebuilt/${abi}/" 2>/dev/null
              echo "Extracted $abi:"
              ls -la "app/prebuilt/${abi}/" || true
            else
              echo "WARNING: Failed to download $abi APK"
            fi
          done
          
          # 验证native库是否正确提取
          echo "=== Checking prebuilt libraries ==="
          echo "Looking for librime_jni.so (note: filename is librime_jni.so, not librime.so)..."
          
          found_libs=0
          for abi in arm64-v8a armeabi-v7a x86 x86_64; do
            if [ -f "app/prebuilt/${abi}/librime_jni.so" ]; then
              echo "✓ Found librime_jni.so for $abi"
              found_libs=$((found_libs + 1))
            else
              echo "✗ Missing librime_jni.so for $abi"
            fi
          done
          
          echo ""
          echo "=== Final prebuilt structure ==="
          find app/prebuilt -name "*.so" -type f -exec ls -lh {} \;
          
          if [ $found_libs -eq 0 ]; then
            echo "ERROR: No native libraries found! APK will crash on launch."
            exit 1
          fi
          
          echo ""
          echo "Successfully extracted $found_libs native library architectures"

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git describe --tags --long --always || echo "No tags"

      - name: Build Debug APK
        run: |
          chmod +x gradlew
          ./gradlew :app:assembleDebug --no-daemon --stacktrace

      - name: List output
        if: always()
        run: |
          find app/build/outputs -name "*.apk" || true

      - uses: actions/upload-artifact@v4
        with:
          name: kitten-keyboard-apk
          path: app/build/outputs/apk/debug/*.apk
